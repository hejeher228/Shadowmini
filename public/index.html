<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ShadowMini üí´</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <style>
    :root {
      --accent: #2196f3; /* –°–∏–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
    }

    body {
      background: #111;
      color: #eee;
      font-family: "Inter", system-ui, sans-serif;
      display: flex;
      height: 100vh;
      margin: 0;
      transition: all 0.3s ease;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: #1a1a1a;
      border-right: 1px solid #333;
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px;
      background: #222;
      border-bottom: 1px solid #333;
    }

    .logo {
      font-weight: bold;
      color: var(--accent);
    }

    .settings-btn {
      background: none;
      border: none;
      color: #aaa;
      cursor: pointer;
      font-size: 1.3em;
    }

    /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ */
    .settings-panel {
      display: none;
      flex-direction: column;
      padding: 15px;
      background: #181818;
      border-top: 1px solid #333;
    }

    .settings-panel.active {
      display: flex;
    }

    .theme-color {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .color-circle {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid #333;
      transition: transform 0.2s;
    }

    .color-circle:hover {
      transform: scale(1.1);
    }

    .add-color {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      color: var(--accent);
      margin-top: 10px;
    }

    /* History */
    .chat-history {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .history-item {
      position: relative;
      background: #181818;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: 0.2s;
    }

    .history-item:hover {
      background: #222;
    }

    .delete-btn {
      position: absolute;
      right: 8px;
      top: 8px;
      display: none;
      background: none;
      border: none;
      color: #ff5252;
      cursor: pointer;
    }

    .history-item:hover .delete-btn {
      display: block;
    }

    /* Chat area */
    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #181818;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    .message {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 12px;
      margin-bottom: 10px;
      line-height: 1.5;
      word-wrap: break-word;
      position: relative;
      animation: fadeIn 0.2s ease;
    }

    .user {
      align-self: flex-end;
      background: var(--accent);
      color: #fff;
    }

    .assistant {
      align-self: flex-start;
      background: #222;
      border: 1px solid #333;
    }

    /* Code block style */
    pre {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 8px;
      overflow: hidden;
      margin-top: 10px;
      position: relative;
    }

    .code-header {
      background: #161b22;
      color: #c9d1d9;
      font-size: 13px;
      padding: 6px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #30363d;
    }

    .copy-btn {
      background: none;
      border: none;
      color: #8b949e;
      cursor: pointer;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: color 0.2s;
    }

    .copy-btn:hover {
      color: var(--accent);
    }

    pre code {
      display: block;
      padding: 14px;
      font-family: "Fira Code", monospace;
      font-size: 14px;
      overflow-x: auto;
    }

    /* Input */
    .chat-input {
      display: flex;
      align-items: center;
      padding: 12px;
      background: #111;
      border-top: 1px solid #333;
    }

    .chat-input textarea {
      flex: 1;
      background: #222;
      border: none;
      color: #fff;
      padding: 10px;
      border-radius: 8px;
      resize: none;
      font-family: inherit;
      height: 50px;
    }

    .chat-input button {
      margin-left: 10px;
      padding: 10px 14px;
      border: none;
      border-radius: 50%;
      background: var(--accent);
      color: #fff;
      font-size: 1.2em;
      cursor: pointer;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-header">
      <span class="logo">ShadowMini</span>
      <button class="settings-btn" id="settingsBtn"><i class="fa-solid fa-gear"></i></button>
    </div>

    <div class="settings-panel" id="settingsPanel">
      <div class="theme-color" id="themeColors">
        <div class="color-circle" style="background:#2196f3" data-color="#2196f3"></div>
        <div class="color-circle" style="background:#4caf50" data-color="#4caf50"></div>
        <div class="color-circle" style="background:#9c27b0" data-color="#9c27b0"></div>
        <div class="color-circle" style="background:#f44336" data-color="#f44336"></div>
      </div>
      <label class="add-color"><i class="fa-solid fa-paintbrush"></i> –î–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–π —Ü–≤–µ—Ç
        <input type="color" id="customColor" hidden>
      </label>
    </div>

    <div class="chat-history" id="history"></div>
  </div>

  <div class="chat-area">
    <div class="chat-messages" id="messages"></div>
    <div class="chat-input">
      <textarea id="userInput" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
      <button id="sendBtn"><i class="fa-solid fa-paper-plane"></i></button>
    </div>
  </div>

  <script>
  hljs.highlightAll();

  const messagesEl = document.getElementById('messages');
  const input = document.getElementById('userInput');
  const sendBtn = document.getElementById('sendBtn');
  const historyEl = document.getElementById('history');
  const settingsBtn = document.getElementById('settingsBtn');
  const settingsPanel = document.getElementById('settingsPanel');

  let chatHistory = JSON.parse(localStorage.getItem('shadowmini_history')) || [];
  let currentChatIndex = null;

  function saveHistory() {
    localStorage.setItem('shadowmini_history', JSON.stringify(chatHistory));
    renderHistory();
  }

  function renderHistory() {
    historyEl.innerHTML = '';
    if (chatHistory.length === 0) {
      historyEl.innerHTML = '<p style="text-align:center;color:#777;">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</p>';
      return;
    }

    chatHistory.forEach((item, i) => {
      const el = document.createElement('div');
      el.className = 'history-item';
      el.innerHTML = `
        <span>${item.title}</span>
        <button class="delete-btn" onclick="deleteHistory(${i}); event.stopPropagation();">
          <i class="fa-solid fa-trash"></i>
        </button>
      `;
      el.onclick = () => loadChat(i);
      historyEl.appendChild(el);
    });
  }

  function deleteHistory(i) {
    if (currentChatIndex === i) {
      messagesEl.innerHTML = '';
      currentChatIndex = null;
    }
    chatHistory.splice(i, 1);
    saveHistory();
  }

  function loadChat(i) {
    const chat = chatHistory[i];
    messagesEl.innerHTML = chat.content;
    currentChatIndex = i;
    hljs.highlightAll();
  }

  function addMessage(role, text) {
    const msg = document.createElement('div');
    msg.className = `message ${role}`;
    const codeRegex = /```([a-zA-Z0-9]*)\n([\s\S]*?)```/g;

    let formatted = text.replace(codeRegex, (_, lang, code) => `
      <div class="code-block">
        <div class="code-header">
          <span>${lang || '–∫–æ–¥'}</span>
          <button class="copy-btn" onclick="copyCode(this)">
            <i class="fa-regular fa-copy"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
          </button>
        </div>
        <pre><code class="${lang}">${code.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</code></pre>
      </div>
    `);

    msg.innerHTML = formatted;
    messagesEl.appendChild(msg);
    hljs.highlightAll();
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function copyCode(btn) {
    const code = btn.closest('.code-block').querySelector('code').innerText;
    navigator.clipboard.writeText(code);
    btn.innerHTML = '<i class="fa-solid fa-check"></i> –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ';
    setTimeout(() => (btn.innerHTML = '<i class="fa-regular fa-copy"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å'), 1500);
  }

  sendBtn.onclick = async () => {
    const text = input.value.trim();
    if (!text) return;

    addMessage('user', text);
    input.value = '';

    const response = await fetch('/api', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ messages: [text] })
    });

    const data = await response.json();
    addMessage('assistant', data.reply || '–û—à–∏–±–∫–∞ ‚ùå');

    if (currentChatIndex === null) {
      currentChatIndex = chatHistory.length;
      chatHistory.push({ title: text.slice(0, 30) + '...', content: messagesEl.innerHTML });
    } else {
      chatHistory[currentChatIndex].content = messagesEl.innerHTML;
      chatHistory[currentChatIndex].title = text.slice(0, 30) + '...';
    }

    saveHistory();
  };

  // --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (—Ü–≤–µ—Ç–∞, —Ç–µ–º—ã) ---
  settingsBtn.onclick = () => settingsPanel.classList.toggle('active');

  document.querySelectorAll('.color-circle').forEach(btn => {
    btn.onclick = () => {
      document.documentElement.style.setProperty('--accent', btn.dataset.color);
      localStorage.setItem('shadowmini_color', btn.dataset.color);
    };
  });

  const customColor = document.getElementById('customColor');
  document.querySelector('.add-color').onclick = () => customColor.click();
  customColor.oninput = (e) => {
    const color = e.target.value;
    document.documentElement.style.setProperty('--accent', color);
    localStorage.setItem('shadowmini_color', color);
  };

  // --- –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–º—ã –∏ –∏—Å—Ç–æ—Ä–∏–∏ ---
  const savedColor = localStorage.getItem('shadowmini_color');
  if (savedColor) document.documentElement.style.setProperty('--accent', savedColor);

  renderHistory();
</script>

</body>
</html>
